name: Build & Deploy to Production

on:
  workflow_dispatch:
  release:
    types: [published]

env:
  DEPLOY_DIR: /home/shirologic/deploy/analytics
  OLD_DEPLOY_DIR: /home/shirologic/nexus/analytics

jobs:
  build-ui:
    name: Build analytics-ui
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set lowercase image name
        run: echo "IMAGE=ghcr.io/$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')/analytics-ui" >> $GITHUB_ENV

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push analytics-ui
        uses: docker/build-push-action@v6
        with:
          context: ./analytics-ui
          platforms: linux/amd64
          push: true
          tags: ${{ env.IMAGE }}:latest
          cache-from: type=gha,scope=analytics-ui
          cache-to: type=gha,mode=max,scope=analytics-ui

  build-ai-service:
    name: Build analytics-ai-service
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set lowercase image name
        run: echo "IMAGE=ghcr.io/$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')/analytics-ai-service" >> $GITHUB_ENV

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push analytics-ai-service
        uses: docker/build-push-action@v6
        with:
          context: ./analytics-ai-service
          file: ./analytics-ai-service/docker/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ env.IMAGE }}:latest
          cache-from: type=gha,scope=analytics-ai-service
          cache-to: type=gha,mode=max,scope=analytics-ai-service

  deploy:
    name: Deploy to server
    needs: [build-ui, build-ai-service]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: OPENROUTER_API_KEY,JWT_SECRET,GHCR_USER,GHCR_TOKEN
          script: |
            set -e

            # Stop old installer deployment (ignore errors if it doesn't exist)
            if [ -f "${{ env.OLD_DEPLOY_DIR }}/docker-compose.yaml" ]; then
              echo "Stopping old installer deployment..."
              docker compose -f ${{ env.OLD_DEPLOY_DIR }}/docker-compose.yaml down --remove-orphans || true
            fi

            # Clone or pull the repo
            if [ -d "${{ env.DEPLOY_DIR }}/.git" ]; then
              echo "Pulling latest code..."
              git -C ${{ env.DEPLOY_DIR }} pull --ff-only
            else
              echo "Cloning repo..."
              mkdir -p ${{ env.DEPLOY_DIR }}
              git clone --depth=1 --recurse-submodules https://github.com/NexusQuantum/NQRust-Analytics.git ${{ env.DEPLOY_DIR }}
            fi

            # Write .env from secrets
            cat > ${{ env.DEPLOY_DIR }}/.env << ENVEOF
            OPENROUTER_API_KEY=$OPENROUTER_API_KEY
            JWT_SECRET=$JWT_SECRET
            JWT_ACCESS_EXPIRES_IN=7d
            JWT_REFRESH_EXPIRES_IN_DAYS=30
            DB_TYPE=sqlite
            SQLITE_FILE=/app/data/db.sqlite3
            TELEMETRY_ENABLED=false
            NEXT_PUBLIC_TELEMETRY_ENABLED=false
            ENVEOF

            # Login to ghcr.io and pull new images
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin

            cd ${{ env.DEPLOY_DIR }}
            docker compose -f docker-compose.prod.yaml pull

            # Start services
            docker compose -f docker-compose.prod.yaml up -d --remove-orphans

            echo "Deployment complete."
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          GHCR_USER: ${{ github.actor }}
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
