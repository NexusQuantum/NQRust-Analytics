volumes:
  data:
  northwind_data:


networks:
  analytics:
    driver: bridge

services:


  analytics-service:
    # Build from local source instead of using online image
    build:
      context: ./analytics-ai-service
      dockerfile: docker/Dockerfile

    restart: on-failure
    platform: linux/amd64
    image: analytics-service:local
    expose:
      - 5555
    ports:
      - "5555:5555"
    environment:
      PYTHONUNBUFFERED: 1
      CONFIG_PATH: /app/config.yaml
      ANALYTICS_UI_ENDPOINT: http://analytics-ui:3000
    env_file:
      - .env
    volumes:
      - ./config.yaml:/app/config.yaml:ro
      - ./data:/app/data:ro
    networks:
      - analytics
    depends_on:
      - qdrant

  qdrant:
    image: qdrant/qdrant:v1.11.0
    restart: on-failure
    expose:
      - 6333
      - 6334
    volumes:
      - data:/qdrant/storage
    networks:
      - analytics

  analytics-engine:
    image: ghcr.io/nexusquantum/analytics-engine:latest
    restart: on-failure
    platform: linux/amd64
    ports:
      - "8080:8080"
    volumes:
      - data:/usr/src/app/etc
      - ./analytics-engine/analytics-core-legacy/docker/etc/config.properties:/usr/src/app/etc/config.properties:ro
    networks:
      - analytics

  ibis-server:
    image: ghcr.io/nexusquantum/analytics-engine-ibis:latest
    restart: on-failure
    platform: linux/amd64
    ports:
      - "8000:8000"
    networks:
      - analytics
    depends_on:
      - analytics-engine

  # Northwind PostgreSQL Demo Database
  northwind-db:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_DB: northwind
      POSTGRES_USER: demo
      POSTGRES_PASSWORD: demo123
    ports:
      - "5432:5432"
    volumes:
      - ./northwind.sql:/docker-entrypoint-initdb.d/northwind.sql:ro
      - northwind_data:/var/lib/postgresql/data
    networks:
      - analytics

  analytics-ui:
    build:
      context: ./analytics-ui
      dockerfile: Dockerfile
    restart: on-failure
    platform: linux/amd64
    image: analytics-ui:local
    hostname: analytics-ui
    environment:
      DB_TYPE: sqlite
      SQLITE_FILE: /app/data/db.sqlite3
      PERSIST_CREDENTIAL_DIR: /app/data
      ANALYTICS_ENGINE_ENDPOINT: http://analytics-engine:8080
      ANALYTICS_AI_ENDPOINT: http://analytics-service:5555
      IBIS_SERVER_ENDPOINT: http://ibis-server:8000
      GENERATION_MODEL: gpt-4o-mini
      ANALYTICS_ENGINE_PORT: 8080
      ANALYTICS_AI_SERVICE_VERSION: 0.27.1
      ANALYTICS_UI_VERSION: 0.31.1
      ANALYTICS_ENGINE_VERSION: 0.18.3
      USER_UUID: demo-user-123
      TELEMETRY_ENABLED: false
      NEXT_PUBLIC_TELEMETRY_ENABLED: false
      EXPERIMENTAL_ENGINE_RUST_VERSION: false
      ANALYTICS_PRODUCT_VERSION: 0.27.0
      LICENSE_KEY: ${LICENSE_KEY:-}
      LICENSE_API_KEY: ${LICENSE_API_KEY:-}
      LICENSE_SERVER_URL: ${LICENSE_SERVER_URL:-https://billing.nexusquantum.id}
      LICENSE_FILE_PATH: ${LICENSE_FILE_PATH:-}
      LICENSE_GRACE_PERIOD_DAYS: ${LICENSE_GRACE_PERIOD_DAYS:-7}
      LICENSE_PUBLIC_KEY: ${LICENSE_PUBLIC_KEY:-}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "13000:3000"
    volumes:
      - data:/app/data
    networks:
      - analytics
    depends_on:
      - analytics-service
      - analytics-engine
      - ibis-server
